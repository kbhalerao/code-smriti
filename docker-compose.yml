version: '3.8'

services:
  # Couchbase Database - stores code chunks with embeddings and metadata
  couchbase:
    image: couchbase/server:enterprise-7.6.2
    container_name: codesmriti_couchbase
    restart: unless-stopped
    ports:
      - "8091-8097:8091-8097"  # Web UI and various services
      - "9123:9123"             # Cluster management
      - "11207:11207"           # Memcached SSL
      - "11210:11210"           # Memcached
      - "11280:11280"           # Data service
      - "18091-18097:18091-18097" # SSL ports
    volumes:
      - couchbase_data:/opt/couchbase/var
      - ./scripts/init-couchbase.sh:/opt/init-couchbase.sh
    environment:
      - COUCHBASE_ADMINISTRATOR_USERNAME=${COUCHBASE_USERNAME:-Administrator}
      - COUCHBASE_ADMINISTRATOR_PASSWORD=${COUCHBASE_PASSWORD}
    networks:
      - codesmriti_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/pools"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # MCP Server - FastMCP implementation with HTTP/SSE for remote access
  mcp-server:
    build:
      context: ./mcp-server
      dockerfile: Dockerfile
    container_name: codesmriti_mcp_server
    restart: unless-stopped
    ports:
      - "8080:8080"  # HTTP/SSE for remote MCP access
    environment:
      - COUCHBASE_HOST=couchbase
      - COUCHBASE_PORT=8091
      - COUCHBASE_USERNAME=${COUCHBASE_USERNAME:-Administrator}
      - COUCHBASE_PASSWORD=${COUCHBASE_PASSWORD}
      - COUCHBASE_BUCKET=${COUCHBASE_BUCKET:-code_memory}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - EMBEDDING_MODEL=nomic-ai/nomic-embed-text-v1.5
      - JWT_SECRET=${JWT_SECRET}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./mcp-server:/app
      - model_cache:/root/.cache/huggingface
      - model_cache:/root/.cache/torch
    depends_on:
      couchbase:
        condition: service_healthy
    networks:
      - codesmriti_network
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Access Mac's Ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Ingestion Worker - background service for processing repositories
  ingestion-worker:
    build:
      context: ./ingestion-worker
      dockerfile: Dockerfile
    container_name: codesmriti_ingestion_worker
    restart: unless-stopped
    environment:
      - COUCHBASE_HOST=couchbase
      - COUCHBASE_PORT=8091
      - COUCHBASE_USERNAME=${COUCHBASE_USERNAME:-Administrator}
      - COUCHBASE_PASSWORD=${COUCHBASE_PASSWORD}
      - COUCHBASE_BUCKET=${COUCHBASE_BUCKET:-code_memory}
      - EMBEDDING_MODEL=nomic-ai/nomic-embed-text-v1.5
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOS=${GITHUB_REPOS}  # Comma-separated list
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./ingestion-worker:/app
      - ./repos:/repos  # Mount for local repo clones
      - model_cache:/root/.cache/huggingface
      - model_cache:/root/.cache/torch
    depends_on:
      couchbase:
        condition: service_healthy
    networks:
      - codesmriti_network

  # API Gateway - Nginx reverse proxy for SSL and routing
  api-gateway:
    image: nginx:alpine
    container_name: codesmriti_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./api-gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./api-gateway/ssl:/etc/letsencrypt:ro  # Let's Encrypt certificates
      - ./api-gateway/certbot:/var/www/certbot:ro  # ACME challenges
    depends_on:
      - mcp-server
    networks:
      - codesmriti_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  couchbase_data:
    driver: local
  model_cache:
    driver: local

networks:
  codesmriti_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
