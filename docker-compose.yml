services:
  # Couchbase Database - stores code chunks with embeddings and metadata
  couchbase:
    image: couchbase/server:enterprise-7.6.2
    container_name: codesmriti_couchbase
    restart: unless-stopped
    ports:
      - "8091-8097:8091-8097"  # Web UI and various services
      - "9123:9123"             # Cluster management
      - "11207:11207"           # Memcached SSL
      - "11210:11210"           # Memcached
      - "11280:11280"           # Data service
      - "18091-18097:18091-18097" # SSL ports
    volumes:
      - couchbase_data:/opt/couchbase/var
      - ./scripts/setup/init-couchbase.sh:/opt/init-couchbase.sh
    environment:
      - COUCHBASE_ADMINISTRATOR_USERNAME=${COUCHBASE_USERNAME:-Administrator}
      - COUCHBASE_ADMINISTRATOR_PASSWORD=${COUCHBASE_PASSWORD}
    networks:
      - codesmriti_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/ui/index.html"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # API Server - FastAPI server (RAG chat + Chief of Staff)
  api-server:
    build:
      context: .
      dockerfile: ./services/api-server/Dockerfile
    container_name: codesmriti_api_server
    restart: unless-stopped
    ports:
      - "8000:8000"  # FastAPI server
    environment:
      - COUCHBASE_HOST=couchbase
      - COUCHBASE_PORT=8091
      - COUCHBASE_USER=Administrator
      - COUCHBASE_PASSWORD=${COUCHBASE_PASSWORD}
      - COUCHBASE_BUCKET_CODE=code_kosha
      - COUCHBASE_BUCKET_USERS=users
      - COUCHBASE_BUCKET_JOBS=ingestion_jobs
      - COUCHBASE_BUCKET_COS=chief_of_staff
      - COS_DEFAULT_USER=${COS_DEFAULT_USER:-}
      - OLLAMA_HOST=http://host.docker.internal:1234
      - LLM_MODEL_NAME=${LLM_MODEL_NAME:-qwen/qwen3-30b-a3b-2507}
      - EMBEDDING_MODEL_NAME=${EMBEDDING_MODEL_NAME:-nomic-ai/nomic-embed-text-v1.5}
      - JWT_SECRET=${JWT_SECRET}
      - AES_ENCRYPTION_KEY=${AES_ENCRYPTION_KEY}
      - API_USERNAME=${API_USERNAME}
      - API_PASSWORD=${API_PASSWORD}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./services/api-server/logs:/app/logs
      - model_cache:/root/.cache/huggingface
      - model_cache:/root/.cache/torch
      - ${REPOS_PATH:-/Users/kaustubh/Documents/codesmriti-repos}:/repos:ro  # For CodeFetcher
    depends_on:
      couchbase:
        condition: service_healthy
    networks:
      - codesmriti_network
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Access Mac's Ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s  # Allow 2 minutes for embedding model loading

  # Ingestion Worker - background service for processing repositories
  ingestion-worker:
    build:
      context: ./services/ingestion-worker
      dockerfile: Dockerfile
    container_name: codesmriti_ingestion_worker
    restart: "no"  # Run manually - don't auto-restart after completion
    profiles:
      - manual  # Don't start automatically, only when manually triggered
    environment:
      - COUCHBASE_HOST=couchbase
      - COUCHBASE_PORT=8091
      - COUCHBASE_USERNAME=${COUCHBASE_USERNAME:-Administrator}
      - COUCHBASE_PASSWORD=${COUCHBASE_PASSWORD}
      - COUCHBASE_BUCKET=${COUCHBASE_BUCKET:-code_memory}
      - EMBEDDING_MODEL=nomic-ai/nomic-embed-text-v1.5
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOS=${GITHUB_REPOS}  # Comma-separated list
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./services/ingestion-worker:/app
      - ./repos:/repos  # Mount for local repo clones
      - model_cache:/root/.cache/huggingface
      - model_cache:/root/.cache/torch
    depends_on:
      couchbase:
        condition: service_healthy
    networks:
      - codesmriti_network

  # API Gateway - Nginx reverse proxy for SSL and routing
  api-gateway:
    image: nginx:alpine
    container_name: codesmriti_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./services/api-gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./services/api-gateway/ssl:/etc/letsencrypt:ro  # Let's Encrypt certificates
      - ./services/api-gateway/certbot:/var/www/certbot:ro  # ACME challenges
      - ./landing:/usr/share/nginx/html:ro  # Landing page
    depends_on:
      api-server:
        condition: service_healthy
    networks:
      - codesmriti_network
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Access host's Ollama
    healthcheck:
      test: ["CMD-SHELL", "pgrep nginx"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  couchbase_data:
    driver: local
  model_cache:
    driver: local

networks:
  codesmriti_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
