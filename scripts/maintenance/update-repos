#!/bin/bash
#
# Pipeline Ingestion Runner - Run in tmux
# This script runs the full pipeline ingestion in a tmux session
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$PROJECT_ROOT"

# Load environment variables
if [ -f "$PROJECT_ROOT/.env" ]; then
    source "$PROJECT_ROOT/.env"
else
    echo "Warning: .env file not found. Using default REPOS_PATH=/repos"
    REPOS_PATH="${REPOS_PATH:-/repos}"
fi

# Activate virtual environment
if [ -f "$PROJECT_ROOT/lib/ingestion-worker/venv/bin/activate" ]; then
    source "$PROJECT_ROOT/lib/ingestion-worker/venv/bin/activate"
else
    echo "Error: Virtual environment not found at $PROJECT_ROOT/lib/ingestion-worker/venv"
    echo "Run 0-setup/install.sh first."
    exit 1
fi

# Set log file with timestamp
LOGFILE="/tmp/pipeline-ingestion-$(date +%Y%m%d-%H%M%S).log"

echo "======================================================================="
echo "PIPELINE INGESTION - Full Repository Queue"
echo "======================================================================="
echo ""
echo "Log file: $LOGFILE"
echo "Working directory: $(pwd)"
echo "Repos path: ${REPOS_PATH}"
echo ""
echo "Starting pipeline ingestion..."
echo ""

# Run pipeline with full output logging
python3 2-initialize/pipeline_ingestion.py 2>&1 | tee "$LOGFILE"

# Show completion message
echo ""
echo "======================================================================="
echo "Pipeline ingestion completed!"
echo "Log file: $LOGFILE"
echo "======================================================================="
