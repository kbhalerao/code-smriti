# CodeSmriti V4 Document Schema Specification

**Version**: 4.0
**Date**: 2025-11-30
**Status**: Complete (101 repos, 48K documents indexed)

## Overview

V4 introduces a hierarchical document structure with bottom-up summary aggregation. All documents are stored in Couchbase with vector embeddings for semantic search.

## Key Changes from V3

| Field | V3 | V4 |
|-------|-----|-----|
| Primary key | `chunk_id` | `document_id` |
| Code storage | `code_text` field | NOT stored (summaries only) |
| Document types | `code_chunk`, `document`, `commit` | `repo_summary`, `module_summary`, `file_index`, `symbol_index` |
| Language field | Root level `language` | `metadata.language` |
| Line numbers | Root level `start_line`, `end_line` | `metadata.start_line`, `metadata.end_line` |
| Quality tracking | `version.protect_from_update` | `quality` object with enrichment details |

## Document Hierarchy

```
repo_summary (1 per repository)
├── module_summary (1 per folder)
│   ├── module_summary (nested folders)
│   │   └── file_index (1 per file)
│   │       └── symbol_index (functions/classes >= 5 lines)
│   └── file_index
│       └── symbol_index
└── module_summary
    └── ...
```

## Common Fields (All Document Types)

```json
{
    "document_id": "string (SHA256 hash)",
    "type": "repo_summary | module_summary | file_index | symbol_index",
    "repo_id": "owner/repo",
    "content": "LLM-generated summary for search",
    "embedding": [/* 768-dim float array */],

    "quality": {
        "enrichment_level": "llm_summary | basic | none",
        "llm_available": true,
        "summary_source": "llm_direct | aggregated_from_* | docstring | fallback",
        "enrichment_cost": 0,
        "is_underchunked": false,
        "underchunk_reason": "",
        "llm_chunks_added": 0
    },

    "version": {
        "schema_version": "v4.0",
        "pipeline_version": "2025.11.28",
        "created_at": "ISO8601 timestamp",
        "updated_at": null
    }
}
```

## Document Types

### 1. repo_summary

Top-level document representing an entire repository.

```json
{
    "document_id": "<SHA256 hash of 'repo:{repo_id}:{commit}'>",
    "type": "repo_summary",
    "repo_id": "kbhalerao/labcore",
    "commit_hash": "abc123def456...",

    "content": "Repository overview generated by LLM...",
    "embedding": [/* 768 floats */],

    "metadata": {
        "total_files": 450,
        "total_lines": 125000,
        "languages": {"python": 380, "html": 45},
        "tech_stack": ["django", "postgresql", "celery"],
        "modules": ["associates", "samples", "workflows"]
    },

    "children_ids": ["<module_summary document_ids>"],

    "quality": { /* see common fields */ },
    "version": { /* see common fields */ }
}
```

### 2. module_summary

Represents a folder/directory in the repository.

```json
{
    "document_id": "<SHA256 hash of 'module:{repo_id}:{path}:{commit}'>",
    "type": "module_summary",
    "repo_id": "kbhalerao/labcore",
    "module_path": "associates",
    "commit_hash": "abc123def456...",

    "content": "Module overview generated by LLM...",
    "embedding": [/* 768 floats */],

    "metadata": {
        "file_count": 12,
        "key_files": ["models.py", "views.py"]
    },

    "parent_id": "<repo_summary or parent module_summary document_id>",
    "children_ids": ["<file_index or nested module_summary document_ids>"],

    "quality": { /* see common fields */ },
    "version": { /* see common fields */ }
}
```

### 3. file_index

Represents a single source file.

```json
{
    "document_id": "<SHA256 hash of 'file:{repo_id}:{path}:{commit}'>",
    "type": "file_index",
    "repo_id": "kbhalerao/labcore",
    "file_path": "associates/models.py",
    "commit_hash": "abc123def456...",

    "content": "File summary generated by LLM...",
    "embedding": [/* 768 floats */],

    "metadata": {
        "line_count": 245,
        "language": "python",
        "imports": ["django.db.models", "guardian.shortcuts"],
        "symbols": [
            {
                "name": "UserModel",
                "type": "class",
                "lines": [15, 89],
                "significant": true,
                "docstring": "User model with organization...",
                "methods": [
                    {"name": "__str__", "lines": [45, 47]},
                    {"name": "get_full_name", "lines": [49, 52]}
                ]
            },
            {
                "name": "helper_func",
                "type": "function",
                "lines": [5, 8],
                "significant": false,
                "docstring": null,
                "methods": []
            }
        ]
    },

    "parent_id": "<module_summary document_id>",
    "children_ids": ["<symbol_index document_ids for significant symbols>"],

    "quality": { /* see common fields */ },
    "version": { /* see common fields */ }
}
```

### 4. symbol_index

Represents a function, class, or method with >= 5 lines.

```json
{
    "document_id": "<SHA256 hash of 'symbol:{repo_id}:{path}:{name}:{commit}'>",
    "type": "symbol_index",
    "repo_id": "kbhalerao/labcore",
    "file_path": "associates/models.py",
    "commit_hash": "abc123def456...",
    "symbol_name": "UserModel",
    "symbol_type": "class",

    "content": "Symbol summary generated by LLM...",
    "embedding": [/* 768 floats */],

    "metadata": {
        "start_line": 15,
        "end_line": 89,
        "line_count": 74,
        "docstring": "User model with organization membership...",
        "methods": [
            {"name": "__str__", "lines": [45, 47]},
            {"name": "get_full_name", "lines": [49, 52]}
        ],
        "inherits": ["AbstractBaseUser", "PermissionsMixin"]
    },

    "parent_id": "<file_index document_id>",

    "quality": { /* see common fields */ },
    "version": { /* see common fields */ }
}
```

## Document ID Generation

Document IDs are SHA256 hashes of deterministic keys for deduplication:

```python
import hashlib

def make_document_id(key: str) -> str:
    return hashlib.sha256(key.encode()).hexdigest()

# Examples:
repo_id     = make_document_id(f"repo:{repo_id}:{commit[:12]}")
module_id   = make_document_id(f"module:{repo_id}:{module_path}:{commit[:12]}")
file_id     = make_document_id(f"file:{repo_id}:{file_path}:{commit[:12]}")
symbol_id   = make_document_id(f"symbol:{repo_id}:{file_path}:{symbol_name}:{commit[:12]}")
```

## Embedding Generation

All embeddings use `nomic-ai/nomic-embed-text-v1.5` with 768 dimensions.

**Prefix**: Always use `search_document:` prefix for indexing (same as V3).

```python
embedding_text = f"search_document: {summary}\n\nCode preview:\n{code_preview[:2000]}"
embedding = model.encode(embedding_text, normalize_embeddings=True)
```

## Quality Object

Tracks LLM enrichment status for each document:

| Field | Type | Description |
|-------|------|-------------|
| `enrichment_level` | enum | `llm_summary`, `basic`, or `none` |
| `llm_available` | bool | Whether LLM was available during ingestion |
| `summary_source` | string | How the summary was generated |
| `enrichment_cost` | int | Estimated tokens used for LLM |
| `is_underchunked` | bool | File needs semantic chunking |
| `underchunk_reason` | string | Why file is underchunked |
| `llm_chunks_added` | int | Additional semantic chunks from LLM |

### Summary Source Values

- `llm_direct` - LLM generated from code directly
- `aggregated_from_symbols` - Aggregated from child symbol summaries
- `aggregated_from_files` - Aggregated from child file summaries
- `aggregated_from_modules` - Aggregated from child module summaries
- `docstring` - Used docstring as summary
- `fallback` - Basic structural summary (no LLM)

## Couchbase Indexes

### Vector Search Index (FTS)

```json
{
    "name": "code_vector_index",
    "type": "fulltext-index",
    "params": {
        "mapping": {
            "types": {
                "_default._default": {
                    "properties": {
                        "embedding": {
                            "enabled": true,
                            "dims": 768,
                            "similarity": "dot_product"
                        },
                        "type": { "enabled": true },
                        "repo_id": { "enabled": true },
                        "content": { "enabled": true },
                        "file_path": { "enabled": true },
                        "symbol_name": { "enabled": true }
                    }
                }
            }
        }
    }
}
```

### N1QL Indexes (Recommended)

```sql
-- Primary lookup by document type
CREATE INDEX idx_v4_type ON `code_kosha`(type) WHERE version.schema_version = "v4.0";

-- Repo listing
CREATE INDEX idx_v4_repos ON `code_kosha`(repo_id, type) WHERE version.schema_version = "v4.0";

-- File lookup
CREATE INDEX idx_v4_files ON `code_kosha`(repo_id, file_path) WHERE type = "file_index";

-- Symbol search
CREATE INDEX idx_v4_symbols ON `code_kosha`(symbol_name, repo_id) WHERE type = "symbol_index";
```

## Migration Notes

When querying V4 documents:

1. Use `type IN ['file_index', 'symbol_index', 'module_summary', 'repo_summary']` instead of `type = 'code_chunk'`
2. Access `metadata.language` instead of root-level `language`
3. Access `metadata.start_line` / `metadata.end_line` instead of root-level
4. The `content` field contains LLM summaries, NOT raw code
5. To get actual code, use the `/api/rag/file` endpoint with line references

## Example Queries

### List all V4 repos with document counts

```sql
SELECT repo_id, COUNT(*) as doc_count
FROM `code_kosha`
WHERE type IN ['file_index', 'symbol_index', 'module_summary', 'repo_summary']
  AND version.schema_version = 'v4.0'
GROUP BY repo_id
ORDER BY doc_count DESC
```

### Find files in a repo

```sql
SELECT document_id, file_path, metadata.language, metadata.line_count
FROM `code_kosha`
WHERE type = 'file_index'
  AND repo_id = 'kbhalerao/labcore'
```

### Search symbols by name

```sql
SELECT symbol_name, file_path, content, metadata.start_line, metadata.end_line
FROM `code_kosha`
WHERE type = 'symbol_index'
  AND LOWER(symbol_name) LIKE '%authenticate%'
```
